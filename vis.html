<!DOCTYPE html>

<html>

<head>
    <title>Visualiser</title>
    <script type="text/javascript" src="js/three.js"></script>
    <script type="text/javascript" src="js/jquery-1.9.0.js"></script>
    <script type="text/javascript" src="js/dat.gui.js"></script>
    <script type="text/javascript" src="js/TrackballControls.js"></script>

    <link href="css/mainStyles.css" rel="stylesheet" type="text/css">
</head>
<body>

<div id="Stats-output">
</div>
<!-- Div which will hold the Output -->
<input type="button" value="Load" class="button"/>
<div id="WebGL-output">
</div>

<!-- Javascript code that runs our Three.js examples -->
<script type="text/javascript">

    // once everything is loaded, we run our Three.js stuff.
    $(function () {


        var clock = new THREE.Clock();

        //var stats = initStats();
        //Set up data

        var data = [{ projectName : "WABI", embed : 98, recip : 98},
            { projectName : "Naked House", embed : 50, recip : 5},
            { projectName : "Polymorphic", embed : 95, recip : 50}];

        //readDataFile("test.json");

        // create a scene, that will hold all our elements such as objects, cameras and lights.
        var scene = new THREE.Scene();

        // create a camera, which defines where we're looking at.
        var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);


        // create a render and set the size
        var webGLRenderer = new THREE.WebGLRenderer();
        webGLRenderer.setClearColorHex(0x5f5f5f, 1.0);
        webGLRenderer.setSize(1024, 768);
        webGLRenderer.shadowMapEnabled = true;

        // position and point the camera to the center of the scene
        camera.position.x = 0;
        camera.position.y = 0;
        camera.position.z = 150;

        //camera.lookAt(new THREE.Vector3(100, 0, 0));

        var trackballControls = new THREE.TrackballControls(camera);

        trackballControls.rotateSpeed = 1.0;
        trackballControls.zoomSpeed = 1.0;
        trackballControls.panSpeed = 1.0;
//        trackballControls.noZoom=false;
//        trackballControls.noPan=false;
        trackballControls.staticMoving = true;

//        trackballControls.dynamicDampingFactor=0.3;

        //Set up graph environment
        setupAxes();

        //Populate the environment
        generateData();

        var ambientLight = new THREE.AmbientLight(0x383838);
        scene.add(ambientLight);

        // add spotlight for the shadows
        var spotLight = new THREE.SpotLight(0xffffff);
        spotLight.position.set(300, 300, 300);
        spotLight.intensity = 1;
        scene.add(spotLight);

        // add the output of the renderer to the html element
        $("#WebGL-output").append(webGLRenderer.domElement);
        console.log("element=", webGLRenderer.domElement);

        // call the render function
        var step = 0;


        // setup the control gui
        var controls = new function () {
            // we need the first child, since it's a multimaterial


        };

        var gui = new dat.GUI();
        var mesh;



        render();

        function render() {
            //stats.update();
            var delta = clock.getDelta();


            trackballControls.update(delta);
            //webGLRenderer.clear();
            // render using requestAnimationFrame
            requestAnimationFrame(render);
            webGLRenderer.render(scene, camera)

        }

        $(document).keydown(function(ev) {
            console.log("Key ", ev.which, " pressed");
            if(ev.which =='P'.charCodeAt(0)) {
                console.log("Camera =", camera.position, "Rot =", camera.rotation);
            }
        });

        function readDataFile(filename) {
            //See if filesaver api supported
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                // All the File APIs are supported.
                console.log("Reading file...");
                var files = ['test.json'];
                var blob = new Blob(files, {type : 'text/plain'}); // the blob
                //Remove extension
                //var files = ["test.json"];
                //filename = files[0];

               // var f = filename;

                var name = blob.name;

                var index = name.lastIndexOf('.');
                if (index>0)
                    name = name.substr(0,index);
                var reader = new FileReader();

                reader.onload = function(evt) {
                    //File loaded - parse it
                    console.log('file read: '+evt.target.result);
                    var jstate = null;
                    try {
                        jstate = JSON.parse(evt.target.result);
                        //restoreState(jstate, mergeFlag);
                    }
                    catch (err) {
                        console.log('error parsing JSON state: '+(err.message ? err.message : err));

                        alert('Sorry, there was a problem reading that file');
                    }
                };

                // Read in the file
                reader.readAsText(name);
            }
            else
                console.log('sorry, file apis not supported');

            var data = [{ projectName : "WABI", embed : 98, recip : 98},
                { projectName : "Naked House", embed : 50, recip : 5},
                { projectName : "Polymorphic", embed : 95, recip : 50}];
        }

        function setupAxes() {
            //Create axes
            //Set up common material
            var material = new THREE.MeshPhongMaterial({color: 0x7777ff});

            //Add graph axes
            var axisYHeight = 100;
            var axisXHeight = 150;
            var axisWidth = 1;
            var cylinderY = new THREE.CylinderGeometry(axisWidth/2, axisWidth/2, axisYHeight, 8, 8, false);
            var cylinderX = new THREE.CylinderGeometry(axisWidth/2, axisWidth/2, axisXHeight, 8, 8, false);

            var axisX = new THREE.Mesh(cylinderX, material);
            var axisY = new THREE.Mesh(cylinderY, material);

            //Orientate axes
            axisX.rotation.z = -Math.PI/2;
            axisX.position.set(0, -axisYHeight/2, 0);
            axisY.position.set(-axisXHeight/2, 0, 0);

            scene.add(axisX);
            scene.add(axisY);
        }

        function generateData() {
            //Create node geometry
            var sphereGeometry = new THREE.SphereGeometry(1,20,20);
            var material = new THREE.MeshPhongMaterial({color: 0x7777ff});

            var nodes = [];
            for(var i=0; i<data.length; ++i) {
                nodes.push(new THREE.Mesh(sphereGeometry,material));
                nodes[i].position.x = data[i].embed - 75;
                nodes[i].position.y = data[i].recip - 50;
                nodes[i].position.z = 0;
                scene.add(nodes[i]);
                generateLabel(data[i].projectName, nodes[i].position);
            }

        }

        function generateLabel(name, position) {
            var fontface = "Arial";
            var fontSize = 18;
            var spacing = 10;

            var canvas = document.createElement('canvas');
            var context = canvas.getContext('2d');
            var metrics = context.measureText( name );
            var textWidth = metrics.width;

            //DEBUG
            console.log("Width=", textWidth);

            canvas.width = textWidth + (spacing * 2);
            canvas.width *= 2;
            canvas.height = fontSize + (spacing * 2);
            context.textAlign = "center";
            context.textBaseline = "middle";

            //DEBUG
            console.log("Canvas=", canvas.width, canvas.height);

            context.fillStyle = "rgba(255, 255, 255, 0.0)";
            context.fillRect(0, 0, canvas.width, canvas.height);
            context.fillStyle = 'White';
            context.font = fontSize + "px " + fontface;

            context.fillText(name, canvas.width/2, canvas.height/2);

            // canvas contents will be used for a texture
            var texture = new THREE.Texture(canvas);
            //var texture = new THREE.ImageUtils.loadTexture("images/label.png");
            texture.needsUpdate = true;

            //texture.needsUpdate = true;
            var spriteMaterial = new THREE.SpriteMaterial({
                        //color: 0xffffff,
                        //transparent: false,
                        useScreenCoordinates: false,
                        alignment: THREE.SpriteAlignment.bottomCenter,
                        map: texture}
            );

            var sprite = new THREE.Sprite(spriteMaterial);
            var scaleX = 20;
            var scaleY = 15;
            sprite.scale.set(scaleX, scaleY, 1);
            sprite.position.set(position.x, position.y, 0);

            scene.add(sprite);
        }

        /*function initStats() {

            var stats = new Stats();
            stats.setMode(0); // 0: fps, 1: ms

            // Align top-left
            stats.domElement.style.position = 'absolute';
            stats.domElement.style.left = '0px';
            stats.domElement.style.top = '0px';

            $("#Stats-output").append(stats.domElement);

            return stats;
        }*/
    });


</script>
</body>
</html>